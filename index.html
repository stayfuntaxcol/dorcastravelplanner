<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dorcas Year Planner — V1</title>
  <style>
    :root{
      --green:#1f9d55; --orange:#ff8c00; --red:#c53030; --ink:#1f2937; --bg:#f7fafc; --muted:#718096; --line:#e2e8f0;
    }
    *{box-sizing:border-box} body{margin:0;font:14px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--ink)}
    header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:#fff;border-bottom:1px solid var(--line);position:sticky;top:0;z-index:10}
    .brand{display:flex;gap:10px;align-items:center}
    .brand .dot{width:10px;height:10px;border-radius:50%;background:var(--green)}
    nav{display:flex;gap:8px;flex-wrap:wrap}
    nav button{border:1px solid var(--line);background:#fff;padding:8px 10px;border-radius:10px;cursor:pointer}
    nav button.active{border-color:var(--green);color:#fff;background:var(--green)}
    main{max-width:1100px;margin:16px auto;padding:0 12px}
    .card{background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px;margin-bottom:12px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    label{display:flex;flex-direction:column;gap:6px}
    input,select,textarea{padding:8px;border:1px solid var(--line);border-radius:8px;background:#fff}
    .muted{color:var(--muted);font-size:12px}
    .btn{padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer}
    .btn.primary{background:var(--green);border-color:var(--green);color:#fff}
    .btn.warn{background:var(--orange);border-color:var(--orange);color:#fff}
    .pill{padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid var(--line);display:inline-block}
    .pill.orange{background:#fff7ed;border-color:#fed7aa;color:#9a3412}
    .pill.green{background:#ecfdf5;border-color:#bbf7d0;color:#065f46}
    .pill.red{background:#fff1f2;border-color:#fecdd3;color:#9f1239}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid var(--line);text-align:left}
    .right{text-align:right}
    .hidden{display:none !important}
    .status-dot{width:10px;height:10px;border-radius:50%;display:inline-block;vertical-align:middle;margin-right:6px}
    .dot-orange{background:var(--orange)} .dot-green{background:var(--green)} .dot-red{background:var(--red)}
    @media (max-width:700px){.row,.row-3{grid-template-columns:1fr}}
  </style>
</head>
<body>

<header>
  <div class="brand"><div class="dot"></div><strong>Dorcas Year Planner — V1</strong></div>
  <div id="authArea">
    <span id="who" class="muted"></span>
    <button id="logoutBtn" class="btn hidden">Log uit</button>
  </div>
</header>

<main>
  <!-- LOGIN / SIGNUP -->
  <section id="authCard" class="card">
    <h3>Inloggen</h3>
    <div class="row">
      <label>E-mail (@dorcas.nl)
        <input id="email" type="email" placeholder="jouwnaam@dorcas.nl"/>
      </label>
      <label>Wachtwoord
        <input id="password" type="password" placeholder="••••••••"/>
      </label>
    </div>
    <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
      <button id="loginBtn" class="btn primary">Log in</button>
      <button id="signupBtn" class="btn">Account aanmaken</button>
      <label style="margin-left:auto;display:flex;gap:6px;align-items:center">
        <input id="extToggle" type="checkbox"/> Uitgebreide gebruikersinvoer (optioneel)
      </label>
    </div>
    <div id="extendedUser" class="row hidden" style="margin-top:10px">
      <label>Volledige naam
        <input id="fullName" placeholder="Voornaam Achternaam"/>
      </label>
      <label>Afdeling (lijst of Anders)
        <input id="department" placeholder="Bijv. Partnerships / Anders"/>
      </label>
      <label>Country Office (lijst of Anders)
        <input id="office" placeholder="Bijv. Kenya / Anders"/>
      </label>
      <label>Rol
        <select id="role">
          <option value="traveler">Reiziger</option>
          <option value="manager">Afdelingsmanager</option>
          <option value="cd">Country Director</option>
          <option value="hr">HR/Safety</option>
          <option value="admin">Admin</option>
        </select>
      </label>
    </div>
    <p class="muted">Tip: voor V1 is registratie beperkt tot *@dorcas.nl*. Rollen kun je later in Admin fine-tunen.</p>
  </section>

  <!-- NAV -->
  <nav id="navBar" class="hidden">
    <button data-tab="tab-trips" class="active">Reizen</button>
    <button data-tab="tab-reviews">Reviews</button>
    <button data-tab="tab-calendar">Kalender</button>
    <button data-tab="tab-dashboard">Dashboard</button>
  </nav>

  <!-- TRIPS -->
  <section id="tab-trips" class="tab card">
    <h3>Nieuwe voorgenomen reis <span class="pill orange"><span class="status-dot dot-orange"></span>oranje</span></h3>
    <form id="tripForm">
      <div class="row">
        <label>Titel
          <input id="f-title" required placeholder="Bijv. Partnerbezoek Nairobi"/>
        </label>
        <label>Type reiziger
          <select id="f-travelerType">
            <option value="medewerker" selected>Medewerker</option>
            <option value="partner">Partner</option>
          </select>
        </label>
      </div>
      <div class="row-3">
        <label>Afdeling
          <input id="f-department" list="departments" placeholder="Kies of typ Anders"/>
          <datalist id="departments"></datalist>
        </label>
        <label>Land (CO)
          <input id="f-country" list="offices" placeholder="Kies of typ Anders"/>
          <datalist id="offices"></datalist>
        </label>
        <label>Stad (optioneel)
          <input id="f-city" placeholder="Bijv. Arusha"/>
        </label>
      </div>
      <div class="row-3">
        <label>Startdatum
          <input id="f-start" type="date" required/>
        </label>
        <label>Einddatum
          <input id="f-end" type="date" required/>
        </label>
        <label>Aantal reizigers
          <input id="f-count" type="number" min="1" value="1"/>
        </label>
      </div>
      <div class="row">
        <label>Doel (Purpose of Travel)
          <select id="f-purpose">
            <option value="Monitoring/Projectbezoek">Monitoring/Projectbezoek</option>
            <option value="Training/Capacity">Training/Capacity</option>
            <option value="Donor/Partnership">Donor/Partnership</option>
            <option value="Conferentie/Netwerk">Conferentie/Netwerk</option>
            <option value="MEAL/Audit">MEAL/Audit</option>
            <option value="E&F Content/Media">E&F Content/Media</option>
            <option value="HR Support">HR Support</option>
            <option value="Overig">Overig</option>
          </select>
        </label>
        <label>Vervoermiddel
          <select id="f-transport">
            <option value="vliegtuig">Vliegtuig</option>
            <option value="trein">Trein</option>
            <option value="auto">Auto</option>
            <option value="anders">Anders</option>
          </select>
        </label>
      </div>
      <div class="row">
        <div>
          <div class="muted">Budget default: €2.500 p.p. — CO₂ default: 2.0 t p.p. </div>
          <div id="calcLine" class="muted">Totaal (schatting): €2.500 • 2.0 t</div>
        </div>
        <div style="text-align:right">
          <button class="btn warn" type="reset">Reset</button>
          <button class="btn primary" type="submit">Opslaan (oranje)</button>
        </div>
      </div>
    </form>

    <h3 style="margin-top:10px">Mijn reizen</h3>
    <div class="card" style="padding:0">
      <table id="tripsTable">
        <thead>
          <tr>
            <th>Status</th><th>Titel</th><th>Afdeling</th><th>CO</th><th>Van</th><th>Tot</th><th>Qtr</th><th class="right">€</th><th class="right">CO₂ (t)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- REVIEWS -->
  <section id="tab-reviews" class="tab card hidden">
    <h3>Te beoordelen reizen</h3>
    <div id="reviewsList" class="card"></div>
  </section>

  <!-- CALENDAR -->
  <section id="tab-calendar" class="tab card hidden">
    <h3>Kalender (Y/Q/M/W)</h3>
    <div style="display:flex;gap:8px;margin-bottom:8px">
      <select id="calView">
        <option value="year">Jaar</option>
        <option value="quarter" selected>Kwartaal</option>
        <option value="month">Maand</option>
        <option value="week">Week</option>
      </select>
      <select id="calQtr">
        <option>Q1</option><option>Q2</option><option>Q3</option><option selected>Q4</option>
      </select>
      <input id="calMonth" type="month"/>
      <input id="calWeek" type="week"/>
    </div>
    <div id="calendarArea" class="card"></div>
  </section>

  <!-- DASHBOARD -->
  <section id="tab-dashboard" class="tab card hidden">
    <h3>Dashboard</h3>
    <div class="row-3">
      <div class="card"><strong># Reizen</strong><div id="kpiTrips" style="font-size:24px">0</div></div>
      <div class="card"><strong>€ Default</strong><div id="kpiBudget" style="font-size:24px">€0</div></div>
      <div class="card"><strong>CO₂ (t)</strong><div id="kpiCO2" style="font-size:24px">0.0</div></div>
    </div>
    <div class="card" style="margin-top:8px">
      <label>Filter Afdeling
        <input id="dashDeptFilter" placeholder="Bijv. Partnerships (leeg = alles)"/>
      </label>
      <div id="dashTableWrap" style="margin-top:8px"></div>
    </div>
  </section>
</main>

<script type="module">
  // Firebase SDKs
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-analytics.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
  import { getFirestore, collection, doc, getDoc, getDocs, setDoc, addDoc, onSnapshot, query, where, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

  // --- CONFIG (gebruik jouw project) ---
  const firebaseConfig = {
    apiKey: "AIzaSyAh8NlJEsAimk5XetB46b4hVmT83ZbHc4o",
    authDomain: "dorcas-travel-planner.firebaseapp.com",
    projectId: "dorcas-travel-planner",
    storageBucket: "dorcas-travel-planner.firebasestorage.app",
    messagingSenderId: "964093814653",
    appId: "1:964093814653:web:5f5a542f9593f82cfe0e14",
    measurementId: "G-PZ3N4JRKQ3"
  };

  const app = initializeApp(firebaseConfig);
  try { getAnalytics(app); } catch(e) {} // analytics optional
  const auth = getAuth(app);
  const db = getFirestore(app);

  // --- UI helpers ---
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const fmtEUR = v => '€' + (v||0).toLocaleString('nl-NL', {maximumFractionDigits:0});
  const fmtDate = s => s ? new Date(s).toLocaleDateString('nl-NL') : '';
  const getQtr = s => {
    const d = new Date(s); const m = d.getMonth()+1;
    return m<=3?'Q1':m<=6?'Q2':m<=9?'Q3':'Q4';
  };

  // Seed lijsten (kun je later uit Firestore laden)
  const DEPARTMENTS = ["Engagement & Fundraising","Partnerships","HRM","Finance","IT","PKS","Quality Management","Shops & Textiles","Country Programmes","Anders"];
  const OFFICES = ["Albania","Ukraine","Moldova","Romania","Egypt","Lebanon","Iraq","Syria","Yemen","Ethiopia","Tanzania","Kenya","Mozambique","South Sudan","Netherlands","Anders"];
  const depDL = $("#departments"), offDL = $("#offices");
  DEPARTMENTS.forEach(x=>{ const o=document.createElement('option'); o.value=x; depDL.appendChild(o); });
  OFFICES.forEach(x=>{ const o=document.createElement('option'); o.value=x; offDL.appendChild(o); });

  // Tabs
  const navBar = $("#navBar");
  navBar.addEventListener('click', (e)=>{
    if(e.target.tagName!=='BUTTON') return;
    $$('#navBar button').forEach(b=>b.classList.toggle('active', b===e.target));
    const tabId = e.target.dataset.tab;
    $$('.tab').forEach(s=>s.classList.add('hidden'));
    $('#'+tabId).classList.remove('hidden');
  });

  // Auth UI
  const authCard = $("#authCard"), who = $("#who"), logoutBtn=$("#logoutBtn");
  const email = $("#email"), password=$("#password"), loginBtn=$("#loginBtn"), signupBtn=$("#signupBtn");
  const extToggle=$("#extToggle"), extBox=$("#extendedUser");
  const fullName=$("#fullName"), department=$("#department"), office=$("#office"), role=$("#role");
  extToggle.addEventListener('change', ()=> extBox.classList.toggle('hidden', !extToggle.checked));

  // Dorcas-domein check
  const isDorcasMail = (m)=>/@dorcas\.nl$/i.test(m||'');

  // Create / Update user profile doc
  async function ensureUserDoc(user, extra={}){
    const uref = doc(db, 'users', user.uid);
    const snap = await getDoc(uref);
    const base = {
      uid:user.uid, email:user.email, displayName:user.displayName||extra.displayName||'',
      role: extra.role || 'traveler',
      department: extra.department || '',
      office: extra.office || '',
      createdAt: serverTimestamp()
    };
    if(!snap.exists()){
      await setDoc(uref, base, {merge:true});
    } else if (Object.keys(extra).length){
      await setDoc(uref, extra, {merge:true});
    }
  }

  // Login / Signup
  loginBtn.onclick = async ()=>{
    try{
      if(!isDorcasMail(email.value)) return alert("Alleen @dorcas.nl toegestaan.");
      const cred = await signInWithEmailAndPassword(auth, email.value, password.value);
    }catch(e){ alert(e.message); }
  };
  signupBtn.onclick = async ()=>{
    try{
      if(!isDorcasMail(email.value)) return alert("Alleen @dorcas.nl toegestaan.");
      const cred = await createUserWithEmailAndPassword(auth, email.value, password.value);
      if(extToggle.checked){
        if(fullName.value) await updateProfile(cred.user, {displayName: fullName.value});
        await ensureUserDoc(cred.user, {
          displayName: fullName.value||'',
          department: department.value||'',
          office: office.value||'',
          role: role.value||'traveler'
        });
      } else {
        await ensureUserDoc(cred.user); // minimal
      }
    }catch(e){ alert(e.message); }
  };
  logoutBtn.onclick = ()=> signOut(auth);

  // State
  let currentUser = null, currentUserDoc = null;

  onAuthStateChanged(auth, async (user)=>{
    currentUser = user || null;
    if(!user){
      authCard.classList.remove('hidden');
      navBar.classList.add('hidden');
      $("#tab-trips").classList.remove('hidden');
      $$('#navBar button').forEach((b,i)=>b.classList.toggle('active', i===0));
      who.textContent = '';
      logoutBtn.classList.add('hidden');
      return;
    }
    // load user profile
    const uref = doc(db,'users',user.uid);
    const s = await getDoc(uref);
    currentUserDoc = s.exists()? s.data() : {email:user.email, role:'traveler'};
    who.textContent = `${user.email} • rol: ${currentUserDoc.role||'traveler'}`;
    logoutBtn.classList.remove('hidden');
    authCard.classList.add('hidden');
    navBar.classList.remove('hidden');
    loadMyTrips();
    loadReviewQueue();
    loadDashboard();
    buildCalendar();
  });

  // ---- TRIP FORM ----
  const f = {
    title: $("#f-title"), travelerType:$("#f-travelerType"),
    department:$("#f-department"), country:$("#f-country"), city:$("#f-city"),
    start:$("#f-start"), end:$("#f-end"), purpose:$("#f-purpose"), transport:$("#f-transport"),
    count:$("#f-count"), calcLine:$("#calcLine")
  };
  const DEFAULT_EUR_PP = 2500; const DEFAULT_TON_CO2_PP = 2.0;

  function refreshCalc(){
    const c = Math.max(1, parseInt(f.count.value||'1',10));
    f.calcLine.textContent = `Totaal (schatting): ${fmtEUR(DEFAULT_EUR_PP*c)} • ${(DEFAULT_TON_CO2_PP*c).toFixed(1)} t`;
  }
  ['input','change'].forEach(ev=> f.count.addEventListener(ev, refreshCalc));
  refreshCalc();

  $("#tripForm").addEventListener('submit', async (e)=>{
    e.preventDefault();
    if(!currentUser) return alert("Log eerst in.");
    const c = Math.max(1, parseInt(f.count.value||'1',10));
    const startISO = f.start.value, endISO = f.end.value;
    if(!startISO || !endISO) return alert("Start- en einddatum zijn verplicht.");
    const qtr = getQtr(startISO);
    const docData = {
      title: f.title.value.trim(),
      travelerUid: currentUser.uid,
      travelerName: currentUser.displayName || (currentUserDoc?.displayName||''),
      travelerType: f.travelerType.value,
      department: f.department.value || (currentUserDoc?.department||''),
      officeCountry: f.country.value || (currentUserDoc?.office||''),
      city: f.city.value || '',
      startDate: startISO, endDate: endISO, qtr,
      purpose: f.purpose.value, transport: f.transport.value,
      travelersCount: c,
      budgetDefaultPerPerson: DEFAULT_EUR_PP,
      budgetDefaultTotal: DEFAULT_EUR_PP*c,
      co2DefaultPerPersonTon: DEFAULT_TON_CO2_PP,
      co2TotalTon: +(DEFAULT_TON_CO2_PP*c).toFixed(1),
      status: "voorgenomen", // oranje
      createdAt: serverTimestamp(),
      currency: "EUR"
    };
    try{
      const tripsRef = collection(db,'trips');
      const added = await addDoc(tripsRef, docData);
      // Initialize approvals (pending)
      const steps = ['manager','cd','hr'];
      for(const step of steps){
        const aDoc = doc(db, `trips/${added.id}/approvals/${step}`);
        await setDoc(aDoc, {
          step, decision:'pending', decidedAt:null, decidedByUid:null, decidedByName:null, note:''
        });
      }
      e.target.reset(); f.count.value=1; refreshCalc();
      loadMyTrips();
      alert("Reis opgeslagen als voorgenomen (oranje).");
    }catch(err){ alert(err.message); }
  });

  // ---- LIST MY TRIPS ----
  const tripsTableBody = $("#tripsTable tbody");
  function statusPill(s){
    if(s==='definitief') return '<span class="pill green"><span class="status-dot dot-green"></span>definitief</span>';
    if(s==='afgewezen') return '<span class="pill red"><span class="status-dot dot-red"></span>afgewezen</span>';
    return '<span class="pill orange"><span class="status-dot dot-orange"></span>voorgenomen</span>';
  }
  function rowTrip(t){
    return `<tr data-id="${t.id}">
      <td>${statusPill(t.status)}</td>
      <td>${t.title||''}</td>
      <td>${t.department||''}</td>
      <td>${t.officeCountry||''}</td>
      <td>${fmtDate(t.startDate)}</td>
      <td>${fmtDate(t.endDate)}</td>
      <td>${t.qtr||''}</td>
      <td class="right">${fmtEUR(t.budgetDefaultTotal)}</td>
      <td class="right">${(t.co2TotalTon||0).toFixed(1)}</td>
    </tr>`;
  }
  function loadMyTrips(){
    if(!currentUser) return;
    const q = query(collection(db,'trips'), where('travelerUid','==', currentUser.uid), orderBy('startDate','desc'));
    onSnapshot(q, (snap)=>{
      tripsTableBody.innerHTML = '';
      let rows = [];
      snap.forEach(d=> rows.push({id:d.id, ...d.data()}));
      rows.sort((a,b)=>(a.startDate||'').localeCompare(b.startDate));
      rows.forEach(t=> tripsTableBody.insertAdjacentHTML('beforeend', rowTrip(t)));
    });
  }

  // ---- DASHBOARD ----
  const kpiTrips=$("#kpiTrips"), kpiBudget=$("#kpiBudget"), kpiCO2=$("#kpiCO2"), dashDeptFilter=$("#dashDeptFilter"), dashTableWrap=$("#dashTableWrap");
  dashDeptFilter.addEventListener('input', loadDashboard);
  function loadDashboard(){
    if(!currentUser) return;
    const qAll = query(collection(db,'trips'));
    onSnapshot(qAll, (snap)=>{
      const rows=[]; snap.forEach(d=> rows.push({id:d.id,...d.data()}));
      const dept = dashDeptFilter.value.trim().toLowerCase();
      const filtered = dept ? rows.filter(r=>(r.department||'').toLowerCase().includes(dept)) : rows;
      const n = filtered.length;
      const sumBudget = filtered.reduce((a,b)=>a+(b.budgetDefaultTotal||0),0);
      const sumCO2 = filtered.reduce((a,b)=>a+(b.co2TotalTon||0),0);
      kpiTrips.textContent = n;
      kpiBudget.textContent = fmtEUR(sumBudget);
      kpiCO2.textContent = sumCO2.toFixed(1);

      // per afdeling tabel
      const group = {};
      filtered.forEach(t=>{
        const d = t.department||'Onbekend';
        group[d] = group[d] || {n:0, eur:0, co2:0};
        group[d].n++; group[d].eur += (t.budgetDefaultTotal||0); group[d].co2 += (t.co2TotalTon||0);
      });
      const table = document.createElement('table');
      table.innerHTML = `<thead><tr><th>Afdeling</th><th class="right">#</th><th class="right">€</th><th class="right">CO₂ (t)</th></tr></thead><tbody></tbody>`;
      const tb = table.querySelector('tbody');
      Object.entries(group).sort((a,b)=>a[0].localeCompare(b[0])).forEach(([d,agg])=>{
        tb.insertAdjacentHTML('beforeend', `<tr>
          <td>${d}</td><td class="right">${agg.n}</td><td class="right">${fmtEUR(agg.eur)}</td><td class="right">${agg.co2.toFixed(1)}</td>
        </tr>`);
      });
      dashTableWrap.innerHTML=''; dashTableWrap.appendChild(table);
    });
  }

  // --- Init view defaults ---
  // Q4 focus bij start
  calView.value = 'quarter'; calQtr.value='Q4';

</script>
</body>
</html>
