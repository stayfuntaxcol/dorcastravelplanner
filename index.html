
<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dorcas Year Planner — V1 (Dashboard KPIs)</title>
  <style>
    :root{ --green:#1f9d55; --orange:#ff8c00; --red:#c53030; --ink:#1f2937; --bg:#f7fafc; --muted:#718096; --line:#e2e8f0; --white:#fff; }
    *{box-sizing:border-box} body{margin:0;font:14px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--ink)}
    header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:#fff;border-bottom:1px solid var(--line);position:sticky;top:0;z-index:10}
    .brand{display:flex;gap:10px;align-items:center}.brand .dot{width:10px;height:10px;border-radius:50%;background:var(--green)}
    nav{display:flex;gap:8px;flex-wrap:wrap} nav button{border:1px solid var(--line);background:#fff;padding:8px 10px;border-radius:10px;cursor:pointer}
    nav button.active{border-color:var(--green);color:#fff;background:var(--green)}
    main{max-width:1200px;margin:16px auto;padding:0 12px}
    .card{background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px;margin-bottom:12px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    label{display:flex;flex-direction:column;gap:6px} input,select,textarea{padding:8px;border:1px solid var(--line);border-radius:8px;background:#fff}
    .muted{color:var(--muted);font-size:12px}
    .btn{padding:8px 10px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer}
    .btn.primary{background:var(--green);border-color:var(--green);color:#fff}
    .btn.warn{background:var(--orange);border-color:var(--orange);color:#fff}
    .pill{padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid var(--line);display:inline-block}
    .pill.orange{background:#fff7ed;border-color:#fed7aa;color:#9a3412}
    .pill.green{background:#ecfdf5;border-color:#bbf7d0;color:#065f46}
    .pill.red{background:#fff1f2;border-color:#fecdd3;color:#9f1239}
    table{width:100%;border-collapse:collapse} th,td{padding:8px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
    .right{text-align:right} .hidden{display:none !important}
    .status-dot{width:10px;height:10px;border-radius:50%;display:inline-block;vertical-align:middle;margin-right:6px}
    .dot-orange{background:var(--orange)} .dot-green{background:var(--green)} .dot-red{background:var(--red)}
    .actions{display:flex;gap:6px;flex-wrap:wrap} .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    /* Modal */
    #modal.backdrop{position:fixed;inset:0;background:rgba(0,0,0,.3);display:flex;align-items:center;justify-content:center;z-index:1000}
    #modal .panel{background:var(--white);border-radius:12px;border:1px solid var(--line);max-width:720px;width:96%;max-height:80vh;overflow:auto;padding:12px}
    #modal h3{margin:0 0 8px}
    @media (max-width:800px){.row,.row-3{grid-template-columns:1fr}}
  </style>
</head>
<body>

<header>
  <div class="brand"><div class="dot"></div><strong>Dorcas Year Planner — V1 (KPIs)</strong></div>
  <div id="authArea">
    <span id="who" class="muted"></span>
    <button id="logoutBtn" class="btn hidden">Log uit</button>
  </div>
</header>

<main>
  <!-- LOGIN / SIGNUP -->
  <section id="authCard" class="card">
    <h3>Inloggen</h3>
    <div class="row">
      <label>E-mail (@dorcas.nl)
        <input id="email" type="email" placeholder="jouwnaam@dorcas.nl"/>
      </label>
      <label>Wachtwoord
        <input id="password" type="password" placeholder="••••••••"/>
      </label>
    </div>
    <div class="toolbar" style="margin-top:8px">
      <button id="loginBtn" class="btn primary">Log in</button>
      <button id="signupBtn" class="btn">Account aanmaken</button>
    </div>
    <details style="margin-top:8px">
      <summary>Uitgebreide gebruikersinvoer (optioneel bij aanmaken)</summary>
      <div class="row" style="margin-top:8px">
        <label>Volledige naam
          <input id="fullName" placeholder="Voornaam Achternaam"/>
        </label>
        <label>Afdeling
          <input id="department" placeholder="Bijv. Partnerships / Anders"/>
        </label>
        <label>Country Office
          <input id="office" placeholder="Bijv. Kenya / Anders"/>
        </label>
        <label>Rol
          <select id="role">
            <option value="traveler">Reiziger</option>
            <option value="manager">Afdelingsmanager</option>
            <option value="cd">Country Director</option>
            <option value="hr">HR/Safety</option>
            <option value="admin">Admin</option>
          </select>
        </label>
      </div>
    </details>
    <p class="muted">Alleen *@dorcas.nl* toegestaan. Rollen beheer je als admin via Firestore of Admin-UI.</p>
  </section>

  <!-- NAV -->
  <nav id="navBar" class="hidden">
    <button data-tab="tab-trips" class="active">Reizen</button>
    <button data-tab="tab-reviews">Reviews</button>
    <button data-tab="tab-calendar">Kalender</button>
    <button data-tab="tab-dashboard">Dashboard</button>
  </nav>

  <!-- TRIPS -->
  <section id="tab-trips" class="tab card">
    <div class="toolbar" style="justify-content:space-between">
      <h3 style="margin:0">Nieuwe voorgenomen reis <span class="pill orange"><span class="status-dot dot-orange"></span>oranje</span></h3>
    </div>

    <form id="tripForm">
      <div class="row">
        <label>Titel
          <input id="f-title" required placeholder="Bijv. Partnerbezoek Nairobi"/>
        </label>
        <label>Type reiziger
          <select id="f-travelerType">
            <option value="medewerker" selected>Medewerker</option>
            <option value="externe-partner">Externe Partner</option>
          </select>
        </label>
      </div>

      <div class="row">
        <label>Bedrijfsnaam/Organisatie (bij Externe Partner) — optioneel
          <input id="f-org" placeholder="Bedrijfsnaam / Organisatie"/>
        </label>
        <label>CombiCode (koppel meerdere reizen)
          <input id="f-combi" placeholder="Bijv. Q4-KE-TZ-2025"/>
        </label>
      </div>

      <div class="row">
        <label style="display:flex;flex-direction:row;align-items:center;gap:8px;margin-top:8px">
          <input id="f-ioBudget" type="checkbox" checked/> IO Budget meerekenen (standaard aan)
        </label>
      </div>

      <div class="row-3">
        <label>Afdeling
          <input id="f-department" list="departments" placeholder="Kies of typ Anders"/>
          <datalist id="departments"></datalist>
        </label>
        <label>Land (CO)
          <input id="f-country" list="offices" placeholder="Kies of typ Anders"/>
          <datalist id="offices"></datalist>
        </label>
        <label>Stad (optioneel)
          <input id="f-city" placeholder="Bijv. Arusha"/>
        </label>
      </div>

      <div class="row-3">
        <label>Startdatum
          <input id="f-start" type="date" required/>
        </label>
        <label>Einddatum
          <input id="f-end" type="date" required/>
        </label>
        <label>Aantal reizigers
          <input id="f-count" type="number" min="1" value="1"/>
        </label>
      </div>

      <div class="row">
        <label>Doel (Purpose of Travel)
          <select id="f-purpose">
            <option value="Monitoring/Projectbezoek">Monitoring/Projectbezoek</option>
            <option value="Training/Capacity">Training/Capacity</option>
            <option value="Donor/Partnership">Donor/Partnership</option>
            <option value="Conferentie/Netwerk">Conferentie/Netwerk</option>
            <option value="MEAL/Audit">MEAL/Audit</option>
            <option value="E&F Content/Media">E&F Content/Media</option>
            <option value="HR Support">HR Support</option>
            <option value="Overig">Overig</option>
          </select>
        </label>
        <label>Vervoermiddel
          <select id="f-transport">
            <option value="vliegtuig">Vliegtuig</option>
            <option value="trein">Trein</option>
            <option value="auto">Auto</option>
            <option value="anders">Anders</option>
          </select>
        </label>
      </div>

      <div class="row" style="align-items:end">
        <div>
          <div class="muted">Budget default: €2.500 p.p. — CO₂ default: 2.5 t per persoon</div>
          <div id="calcLine" class="muted">Totaal (schatting): Budget 2.500 • 2.5 t • 0 dagen</div>
        </div>
        <div style="text-align:right">
          <button class="btn warn" type="reset">Reset</button>
          <button class="btn primary" type="submit">Opslaan (oranje)</button>
        </div>
      </div>
    </form>

    <h3 style="margin-top:10px">Mijn reizen</h3>
    <div class="card" style="padding:0;overflow:auto">
      <table id="tripsTable">
        <thead>
          <tr>
            <th>Status</th><th>Afdeling</th><th>CO</th><th>Van</th><th>Tot</th><th>Qtr</th><th>Dagen</th><th>Budget</th><th>CO₂ (t)</th><th>Combi</th><th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- REVIEWS (simpel) -->
  <section id="tab-reviews" class="tab card hidden">
    <h3>Pending reizen (zichtbaar voor iedereen)</h3>
    <div class="toolbar" style="margin-bottom:8px">
      <input id="revSearch" placeholder="Zoek reis..." style="min-width:220px"/>
      <select id="revDept">
        <option value="">Afdeling: alles</option>
      </select>
      <select id="revSort">
        <option value="date-asc">Sorteren: Datum ↑</option>
        <option value="date-desc">Sorteren: Datum ↓</option>
        <option value="qtr">Sorteren: Qtr</option>
      </select>
    </div>
    <div class="card" style="padding:0;overflow:auto">
      <table id="reviewsTable">
        <thead>
          <tr>
            <th>Status</th><th>Titel</th><th>Afdeling</th><th>CO</th><th>Periode</th><th>Qtr</th><th>Dagen</th><th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- CALENDAR (placeholder V1) -->
  <section id="tab-calendar" class="tab card hidden">
    <h3>Kalender (V1)</h3>
    <div id="calendarArea" class="card"></div>
  </section>

  <!-- DASHBOARD (nieuwe KPI's) -->
  <section id="tab-dashboard" class="tab card hidden">
    <h3>Dashboard</h3>

    <div class="row-3">
      <div class="card"><strong># Reizen Totaal</strong><div id="kpiTripsTotal" style="font-size:24px">0</div></div>
      <div class="card"><strong># Reizen Approved</strong><div id="kpiTripsApproved" style="font-size:24px">0</div></div>
      <div class="card"><strong># Reizen Pending</strong><div id="kpiTripsPending" style="font-size:24px">0</div></div>
    </div>

    <div class="row-3" style="margin-top:8px">
      <div class="card"><strong>€ Budget Totaal</strong><div id="kpiBudgetTotal" style="font-size:24px">€0</div></div>
      <div class="card"><strong>€ Budget Approved</strong><div id="kpiBudgetApproved" style="font-size:24px">€0</div></div>
      <div class="card"><strong>€ Budget Pending</strong><div id="kpiBudgetPending" style="font-size:24px">€0</div></div>
    </div>

    <div class="row-3" style="margin-top:8px">
      <div class="card"><strong>CO₂ (t) Uitstoot Totaal</strong><div id="kpiCO2Total" style="font-size:24px">0.0</div></div>
      <div class="card"><strong>CO₂ (t) Uitstoot Approved</strong><div id="kpiCO2Approved" style="font-size:24px">0.0</div></div>
      <div class="card"><strong>CO₂ (t) Uitstoot Pending</strong><div id="kpiCO2Pending" style="font-size:24px">0.0</div></div>
    </div>

    <div class="card" style="margin-top:8px">
      <label>Filter Afdeling
        <input id="dashDeptFilter" placeholder="Bijv. Partnerships (leeg = alles)"/>
      </label>
      <div id="dashTableWrap" style="margin-top:8px"></div>
      <div id="dashDetailWrap" class="card" style="margin-top:8px"></div>
    </div>
  </section>
</main>

<!-- MODAL -->
<div id="modal" class="hidden"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-analytics.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
  import { getFirestore, collection, doc, getDoc, getDocs, setDoc, addDoc, onSnapshot, query, where, orderBy, serverTimestamp, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAh8NlJEsAimk5XetB46b4hVmT83ZbHc4o",
    authDomain: "dorcas-travel-planner.firebaseapp.com",
    projectId: "dorcas-travel-planner",
    messagingSenderId: "964093814653",
    appId: "1:964093814653:web:5f5a542f9593f82cfe0e14",
    measurementId: "G-PZ3N4JRKQ3"
  };
  const app = initializeApp(firebaseConfig);
  try { getAnalytics(app); } catch(e) {}
  const auth = getAuth(app);
  const db = getFirestore(app);

  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const fmtEUR = v => '€' + (v||0).toLocaleString('nl-NL', {maximumFractionDigits:0});
  const fmtDate = s => s ? new Date(s).toLocaleDateString('nl-NL') : '';
  const fmtPeriod = (a,b)=> `${fmtDate(a)} – ${fmtDate(b)}`;
  const daysBetween = (a,b)=> Math.floor((new Date(b)-new Date(a))/(1000*60*60*24))+1;
  const getQtr = s => { const m=new Date(s).getMonth()+1; return m<=3?'Q1':m<=6?'Q2':m<=9?'Q3':'Q4'; };
  const onSnap = (q, next) => onSnapshot(q, { next, error: e => alert('Firestore: '+e.code+' — '+e.message) });

  const DEPARTMENTS = ["Engagement & Fundraising","Partnerships","HRM","Finance","IT","PKS","Quality Management","Shops & Textiles","Country Programmes","Anders"];
  const OFFICES = ["Albania","Ukraine","Moldova","Romania","Egypt","Lebanon","Iraq","Syria","Yemen","Ethiopia","Tanzania","Kenya","Mozambique","South Sudan","Netherlands","Anders"];
  const depDL = $("#departments"), offDL = $("#offices");
  DEPARTMENTS.forEach(x=>{ const o=document.createElement('option'); o.value=x; depDL.appendChild(o); });
  OFFICES.forEach(x=>{ const o=document.createElement('option'); o.value=x; offDL.appendChild(o); });

  const revDept = document.getElementById('revDept');
  DEPARTMENTS.forEach(x=>{ const op=document.createElement('option'); op.value=x; op.textContent=x; revDept.appendChild(op); });

  const navBar = $("#navBar");
  navBar.addEventListener('click', (e)=>{
    if(e.target.tagName!=='BUTTON') return;
    $$('#navBar button').forEach(b=>b.classList.toggle('active', b===e.target));
    const tabId = e.target.dataset.tab;
    $$('.tab').forEach(s=>s.classList.add('hidden'));
    $('#'+tabId).classList.remove('hidden');
  });

  const authCard = $("#authCard"), who = $("#who"), logoutBtn=$("#logoutBtn");
  const email = $("#email"), password=$("#password"), loginBtn=$("#loginBtn"), signupBtn=$("#signupBtn");
  const fullName=$("#fullName"), department=$("#department"), office=$("#office"), role=$("#role");
  const isDorcasMail = (m)=>/@dorcas\.nl$/i.test(m||'');

  async function ensureUserDoc(user, extra={}){
    const uref = doc(db, 'users', user.uid);
    const snap = await getDoc(uref);
    const base = { uid:user.uid, email:user.email, displayName:user.displayName||extra.displayName||'', role: extra.role || 'traveler', department: extra.department || '', office: extra.office || '', createdAt: serverTimestamp() };
    if(!snap.exists()){ await setDoc(uref, base, {merge:true}); } else if (Object.keys(extra).length){ await setDoc(uref, extra, {merge:true}); }
  }

  loginBtn.onclick = async ()=>{ try{ if(!isDorcasMail(email.value)) return alert("Alleen @dorcas.nl toegestaan."); await signInWithEmailAndPassword(auth, email.value, password.value); }catch(e){ alert(e.code + ' — ' + e.message); } };
  signupBtn.onclick = async ()=>{ try{ if(!isDorcasMail(email.value)) return alert("Alleen @dorcas.nl toegestaan."); const cred = await createUserWithEmailAndPassword(auth, email.value, password.value); if(fullName.value) await updateProfile(cred.user, {displayName: fullName.value}); await ensureUserDoc(cred.user, { displayName: fullName.value||'', department: department.value||'', office: office.value||'', role: role.value||'traveler' }); }catch(e){ alert(e.code + ' — ' + e.message); } };
  logoutBtn.onclick = ()=> signOut(auth);

  let currentUser = null, currentUserDoc = null;
  onAuthStateChanged(auth, async (user)=>{
    currentUser = user || null;
    if(!user){
      authCard.classList.remove('hidden'); navBar.classList.add('hidden'); $("#tab-trips").classList.remove('hidden'); $$('#navBar button').forEach((b,i)=>b.classList.toggle('active', i===0)); who.textContent=''; logoutBtn.classList.add('hidden'); return;
    }
    const uref = doc(db,'users',user.uid);
    const s = await getDoc(uref);
    currentUserDoc = s.exists()? s.data() : {email:user.email, role:'traveler'};
    who.textContent = `${user.email} • rol: ${currentUserDoc.role||'traveler'}`;
    logoutBtn.classList.remove('hidden');
    authCard.classList.add('hidden');
    navBar.classList.remove('hidden');
    loadMyTrips(); loadReviewQueue(); loadDashboard(); buildCalendar();
  });

  const f = { title: $("#f-title"), travelerType:$("#f-travelerType"), org: $("#f-org"), combi: $("#f-combi"), ioBudget: $("#f-ioBudget"), department: $("#f-department"), country:$("#f-country"), city:$("#f-city"), start:$("#f-start"), end:$("#f-end"), purpose:$("#f-purpose"), transport:$("#f-transport"), count:$("#f-count"), calcLine:$("#calcLine") };
  const DEFAULT_EUR_PP = 2500; const DEFAULT_TON_CO2_PP = 2.5;
  function recalcDisplay(){ const c=Math.max(1,parseInt(f.count.value||'1',10)); const io=f.ioBudget.checked; const combiFactor=f.combi.value.trim()?0.5:1; const budgetBase=DEFAULT_EUR_PP*c; const budgetEff=io?budgetBase*combiFactor:0; const co2Eff=(DEFAULT_TON_CO2_PP*c)*combiFactor; let days=0; if(f.start.value&&f.end.value) days=daysBetween(f.start.value,f.end.value); f.calcLine.textContent=`Totaal (schatting): Budget ${budgetEff.toLocaleString('nl-NL')} • ${co2Eff.toFixed(1)} t • ${days} dagen`; }
  ['input','change'].forEach(ev=>{ f.count.addEventListener(ev,recalcDisplay); f.ioBudget.addEventListener(ev,recalcDisplay); f.combi.addEventListener(ev,recalcDisplay); f.start.addEventListener(ev,recalcDisplay); f.end.addEventListener(ev,recalcDisplay); });
  recalcDisplay();
  $("#tripForm").addEventListener('reset', ()=> setTimeout(recalcDisplay,0));

  $("#tripForm").addEventListener('submit', async (e)=>{
    e.preventDefault(); if(!currentUser) return alert("Log eerst in.");
    const c=Math.max(1,parseInt(f.count.value||'1',10)); const startISO=f.start.value, endISO=f.end.value;
    if(!startISO||!endISO) return alert("Start- en einddatum zijn verplicht."); if(new Date(endISO)<=new Date(startISO)) return alert("Einddatum moet later zijn dan begindatum.");
    const qtr=getQtr(startISO); const days=daysBetween(startISO,endISO); const combi=(f.combi.value||'').trim(); const combiFactor=combi?0.5:1; const io=f.ioBudget.checked;
    const budgetBase=DEFAULT_EUR_PP*c; const budgetDefaultTotal=budgetBase; const budgetEffectiveTotal=io?budgetBase*combiFactor:0; const co2Base=(DEFAULT_TON_CO2_PP*c); const co2EffectiveTotalTon=+(co2Base*combiFactor).toFixed(1);
    const docData={ title:f.title.value.trim(), travelerUid:currentUser.uid, travelerName:currentUser.displayName||(currentUserDoc?.displayName||''), travelerType:f.travelerType.value, externalOrgName:f.travelerType.value==='externe-partner'?(f.org.value||''):'', ioBudget:io, combiCode:combi, department:f.department.value||(currentUserDoc?.department||''), officeCountry:f.country.value||(currentUserDoc?.office||''), city:f.city.value||'', startDate:startISO, endDate:endISO, qtr, purpose:f.purpose.value, transport:f.transport.value, travelersCount:c, durationDays:days, budgetDefaultPerPerson:DEFAULT_EUR_PP, budgetDefaultTotal, budgetEffectiveTotal, co2DefaultPerPersonTon:DEFAULT_TON_CO2_PP, co2TotalTon:+co2Base.toFixed(1), co2EffectiveTotalTon, status:"voorgenomen", createdAt:serverTimestamp(), currency:"EUR" };
    try{
      const tripsRef=collection(db,'trips'); const added=await addDoc(tripsRef,docData);
      for (const step of ['manager','cd','hr']){ try{ await setDoc(doc(db,`trips/${added.id}/approvals/${step}`),{ step,decision:'pending',decidedAt:null,decidedByUid:null,decidedByName:null,note:'' }); }catch(e){ console.warn('init approvals failed', step, e?.code); } }
      e.target.reset(); f.count.value=1; f.ioBudget.checked=true; f.combi.value=''; recalcDisplay(); alert("Reis opgeslagen als voorgenomen (oranje).");
    }catch(err){ alert(err.code+' — '+err.message); }
  });

  const tripsTableBody = $("#tripsTable tbody");
  function statusPill(s){ if(s==='definitief') return '<span class="pill green"><span class="status-dot dot-green"></span>definitief</span>'; if(s==='afgewezen') return '<span class="pill red"><span class="status-dot dot-red"></span>afgewezen</span>'; return '<span class="pill orange"><span class="status-dot dot-orange"></span>voorgenomen</span>'; }
  function rowTrip(t){ return `<tr data-id="${t.id}"><td>${statusPill(t.status)}</td><td>${t.department||''}</td><td>${t.officeCountry||''}${t.city?(' • '+t.city):''}</td><td>${fmtDate(t.startDate)}</td><td>${fmtDate(t.endDate)}</td><td>${t.qtr||''}</td><td>${t.durationDays||daysBetween(t.startDate,t.endDate)||''}</td><td class="right">${fmtEUR(t.budgetEffectiveTotal ?? t.budgetDefaultTotal)}</td><td class="right">${(t.co2EffectiveTotalTon ?? t.co2TotalTon || 0).toFixed(1)}</td><td>${t.combiCode||''}</td><td class="right"><button class="btn" data-details="${t.id}">Toon details</button></td></tr>`; }
  function loadMyTrips(){ if(!currentUser) return; const q=query(collection(db,'trips'), where('travelerUid','==', currentUser.uid)); onSnap(q,(snap)=>{ tripsTableBody.innerHTML=''; const rows=[]; snap.forEach(d=> rows.push({id:d.id,...d.data()})); rows.sort((a,b)=>(b.startDate||'').localeCompare(a.startDate||'')); rows.forEach(t=> tripsTableBody.insertAdjacentHTML('beforeend', rowTrip(t))); }); }
  tripsTableBody.addEventListener('click', async (e)=>{ const btn=e.target.closest('button[data-details]'); if(!btn) return; const id=btn.dataset.details; const ref=doc(db,'trips', id); const s=await getDoc(ref); if(s.exists()) openDetails({id, ...s.data()}); });

  const modal = $("#modal");
  function openDetails(t){
    const html = `<div class="backdrop" id="modal" onclick="this.classList.add('hidden')"><div class="panel" onclick="event.stopPropagation()"><div style="display:flex;justify-content:space-between;align-items:center;gap:8px"><h3>${t.title||'Reis'}</h3><button class="btn" onclick="document.getElementById('modal').classList.add('hidden')">Sluiten</button></div><div class="row"><div><div><strong>Status</strong>: ${t.status}</div><div><strong>Afdeling</strong>: ${t.department||''}</div><div><strong>Bestemming</strong>: ${t.officeCountry||''}${t.city?(' • '+t.city):''}</div><div><strong>Periode</strong>: ${fmtPeriod(t.startDate,t.endDate)} (${t.durationDays||daysBetween(t.startDate,t.endDate)} dagen)</div><div><strong>Qtr</strong>: ${t.qtr||''}</div><div><strong>Doel</strong>: ${t.purpose||''}</div><div><strong>Vervoer</strong>: ${t.transport||''}</div></div><div><div><strong>Type reiziger</strong>: ${t.travelerType}</div>${t.externalOrgName?('<div><strong>Bedrijfsnaam/Organisatie</strong>: '+t.externalOrgName+'</div>'):''}<div><strong>Aantal reizigers</strong>: ${t.travelersCount||1}</div><div><strong>CombiCode</strong>: ${t.combiCode||'-'}</div><div><strong>IO Budget</strong>: ${t.ioBudget?'ja':'nee'}</div><div><strong>Euro</strong>: ${fmtEUR(t.budgetEffectiveTotal ?? t.budgetDefaultTotal)}</div><div><strong>CO₂ (t)</strong>: ${(t.co2EffectiveTotalTon ?? t.co2TotalTon || 0).toFixed(1)}</div></div></div></div></div>`;
    modal.outerHTML = html; document.getElementById('modal').classList.remove('hidden');
  }

  // REVIEWS (pending + filters)
  const reviewsTableBody = document.querySelector('#reviewsTable tbody');
  const revSearch = document.getElementById('revSearch');
  const revSort   = document.getElementById('revSort');
  let _revData = [];
  function renderReviews() {
    const q = (revSearch.value || '').trim().toLowerCase();
    let rows = _revData.filter(({trip}) => { const depSel=(revDept.value||''); if(depSel && trip.department !== depSel) return false; if(q && !((trip.title||'').toLowerCase().includes(q))) return false; return true; });
    if (revSort.value === 'qtr') { const ord={Q1:1,Q2:2,Q3:3,Q4:4}; rows.sort((a,b)=>(ord[a.trip.qtr]||0)-(ord[b.trip.qtr]||0) || (a.trip.startDate||'').localeCompare(b.trip.startDate||'')); }
    else if (revSort.value === 'date-desc') { rows.sort((a,b)=>(b.trip.startDate||'').localeCompare(a.trip.startDate||'')); }
    else { rows.sort((a,b)=>(a.trip.startDate||'').localeCompare(b.trip.startDate||'')); }
    const role=(currentUserDoc?.role||'traveler').toLowerCase(); const myStep=role==='manager'?'manager':role==='cd'?'cd':role==='hr'?'hr':role==='admin'?'manager':null;
    reviewsTableBody.innerHTML = '';
    rows.forEach(({trip, ap}) => {
      const mgr=ap.manager?.decision||'pending', cd=ap.cd?.decision||'pending', hr=ap.hr?.decision||'pending';
      const gateOK=(myStep==='manager')||(myStep==='cd'&&mgr==='approved')||(myStep==='hr'&&mgr==='approved'&&cd==='approved');
      const myState=myStep?(ap[myStep]?.decision||'pending'):'none'; const canAct=!!(myStep&&gateOK&&myState==='pending');
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${statusPill(trip.status)}</td><td>${trip.title||''}</td><td>${trip.department||''}</td><td>${trip.officeCountry||''}${trip.city?(' • '+trip.city):''}</td><td>${fmtDate(trip.startDate)} – ${fmtDate(trip.endDate)}</td><td>${trip.qtr||''}</td><td>${trip.durationDays||daysBetween(trip.startDate, trip.endDate)||''}</td><td class="right">${canAct?`<button class="btn" data-approve="${trip.id}">Akkoord</button><button class="btn" data-reject="${trip.id}">Afwijzen</button><button class="btn" data-alt="${trip.id}">Alternatief</button>`:''}<button class="btn" data-details="${trip.id}">Toon details</button></td>`;
      reviewsTableBody.appendChild(tr);
    });
    reviewsTableBody.querySelectorAll('[data-details]').forEach(btn=>{ btn.addEventListener('click', async e=>{ const id=e.currentTarget.getAttribute('data-details'); const s=await getDoc(doc(db,'trips', id)); if (s.exists()) openDetails({id, ...s.data()}); }); });
    reviewsTableBody.querySelectorAll('[data-approve]').forEach(btn=>{ btn.addEventListener('click', ()=> decide(btn.dataset.approve, (currentUserDoc?.role||'traveler').toLowerCase()==='admin'?'manager':(currentUserDoc?.role||'').toLowerCase(), 'approved')); });
    reviewsTableBody.querySelectorAll('[data-reject]').forEach(btn=>{ btn.addEventListener('click', ()=> decide(btn.dataset.reject, (currentUserDoc?.role||'traveler').toLowerCase()==='admin'?'manager':(currentUserDoc?.role||'').toLowerCase(), 'rejected')); });
    reviewsTableBody.querySelectorAll('[data-alt]').forEach(btn=>{ btn.addEventListener('click', ()=> { const note = prompt('Alternatief/reden:', ''); decide(btn.dataset.alt, (currentUserDoc?.role||'traveler').toLowerCase()==='admin'?'manager':(currentUserDoc?.role||'').toLowerCase(), 'alt', note||''); }); });
  }
  function loadReviewQueue(){
    if(!currentUser) return;
    const qTrips = query(collection(db,'trips'), where('status','==','voorgenomen'));
    onSnap(qTrips, async (snap)=>{
      const list=[]; const jobs=[];
      snap.forEach(d=>{ const trip={id:d.id,...d.data()}; jobs.push((async ()=>{ const aSnap=await getDocs(collection(db, `trips/${trip.id}/approvals`)); const ap={}; aSnap.forEach(x=> ap[x.id]=x.data()); list.push({trip, ap}); })()); });
      await Promise.all(jobs); _revData=list; renderReviews();
    });
  }
  async function decide(tripId, step, decision, note='') {
    try { await setDoc(doc(db,`trips/${tripId}/approvals/${step}`), { step, decision, note, decidedAt: serverTimestamp(), decidedByUid: currentUser.uid, decidedByName: currentUser.displayName || currentUser.email }, { merge:true });
      const aSnap=await getDocs(collection(db,`trips/${tripId}/approvals`)); const ap={}; aSnap.forEach(x=> ap[x.id]=x.data());
      if(ap.manager?.decision==='approved' && ap.cd?.decision==='approved' && ap.hr?.decision==='approved'){ await setDoc(doc(db,'trips',tripId), { status:'definitief' }, {merge:true}); alert('Reis is definitief (groen).'); }
    } catch(e) { alert(e.code + ' — ' + e.message); }
  }

  // Calendar placeholder
  function buildCalendar(){ const area=$("#calendarArea"); area.innerHTML='<div class="muted">Komt later (V1: lijstweergave was voldoende).</div>'; }

  // DASHBOARD
  const kpiTripsTotal=$("#kpiTripsTotal"), kpiTripsApproved=$("#kpiTripsApproved"), kpiTripsPending=$("#kpiTripsPending");
  const kpiBudgetTotal=$("#kpiBudgetTotal"), kpiBudgetApproved=$("#kpiBudgetApproved"), kpiBudgetPending=$("#kpiBudgetPending");
  const kpiCO2Total=$("#kpiCO2Total"), kpiCO2Approved=$("#kpiCO2Approved"), kpiCO2Pending=$("#kpiCO2Pending");
  const dashDeptFilter=$("#dashDeptFilter"), dashTableWrap=$("#dashTableWrap"), dashDetailWrap=$("#dashDetailWrap");
  dashDeptFilter.addEventListener('input', loadDashboard);
  function loadDashboard(){
    if(!currentUser) return;
    const qAll = query(collection(db,'trips'));
    onSnap(qAll, (snap)=>{
      const rows=[]; snap.forEach(d=> rows.push({id:d.id,...d.data()}));
      const dept = dashDeptFilter.value.trim().toLowerCase();
      const filtered = dept ? rows.filter(r=>(r.department||'').toLowerCase().includes(dept)) : rows;
      const euroOf = t => (t.budgetEffectiveTotal ?? t.budgetDefaultTotal ?? 0);
      const co2Of  = t => (t.co2EffectiveTotalTon ?? t.co2TotalTon ?? 0);
      const A = filtered.filter(t=> t.status === 'definitief');
      const P = filtered.filter(t=> t.status === 'voorgenomen');
      kpiTripsTotal.textContent = filtered.length; kpiTripsApproved.textContent = A.length; kpiTripsPending.textContent = P.length;
      const bTot=filtered.reduce((a,t)=> a + euroOf(t), 0), bApp=A.reduce((a,t)=> a + euroOf(t), 0), bPen=P.reduce((a,t)=> a + euroOf(t), 0);
      kpiBudgetTotal.textContent = '€' + bTot.toLocaleString('nl-NL', {maximumFractionDigits:0});
      kpiBudgetApproved.textContent = '€' + bApp.toLocaleString('nl-NL', {maximumFractionDigits:0});
      kpiBudgetPending.textContent  = '€' + bPen.toLocaleString('nl-NL', {maximumFractionDigits:0});
      const cTot=filtered.reduce((a,t)=> a + co2Of(t), 0), cApp=A.reduce((a,t)=> a + co2Of(t), 0), cPen=P.reduce((a,t)=> a + co2Of(t), 0);
      kpiCO2Total.textContent=cTot.toFixed(1); kpiCO2Approved.textContent=cApp.toFixed(1); kpiCO2Pending.textContent=cPen.toFixed(1);
      const group={}; filtered.forEach(t=>{ const d=t.department||'Onbekend'; group[d]=group[d]||{n:0, eur:0, co2:0}; group[d].n++; group[d].eur+=euroOf(t); group[d].co2+=co2Of(t); });
      const table=document.createElement('table'); table.innerHTML=`<thead><tr><th>Afdeling</th><th class="right">#</th><th class="right">Euro</th><th class="right">CO₂ (t)</th></tr></thead><tbody></tbody>`; const tb=table.querySelector('tbody');
      Object.entries(group).sort((a,b)=>a[0].localeCompare(b[0])).forEach(([d,agg])=>{ tb.insertAdjacentHTML('beforeend', `<tr><td>${d}</td><td class="right">${agg.n}</td><td class="right">€${agg.eur.toLocaleString('nl-NL',{maximumFractionDigits:0})}</td><td class="right">${agg.co2.toFixed(1)}</td></tr>`); });
      dashTableWrap.innerHTML=''; dashTableWrap.appendChild(table);
      const t2=document.createElement('table'); t2.innerHTML = `<thead><tr><th>Afdeling</th><th>Bestemming</th><th>Vervoer</th><th>Dagen</th><th class="right">Euro</th><th class="right">CO₂ (t)</th><th>Qtr</th><th>Status</th><th>Combi</th><th></th></tr></thead><tbody></tbody>`; const tb2=t2.querySelector('tbody');
      filtered.sort((a,b)=>(a.startDate||'').localeCompare(b.startDate||''));
      filtered.forEach(t=>{ tb2.insertAdjacentHTML('beforeend', `<tr><td>${t.department||''}</td><td>${t.officeCountry||''}${t.city?(' • '+t.city):''}</td><td>${t.transport||''}</td><td>${t.durationDays||daysBetween(t.startDate,t.endDate)||''}</td><td class="right">€${(euroOf(t)).toLocaleString('nl-NL',{maximumFractionDigits:0})}</td><td class="right">${co2Of(t).toFixed(1)}</td><td>${t.qtr||''}</td><td>${t.status||''}</td><td>${t.combiCode||''}</td><td class="right"><button class="btn" data-dash-details="${t.id}">Toon details</button></td></tr>`); });
      dashDetailWrap.innerHTML=''; dashDetailWrap.appendChild(t2);
      dashDetailWrap.querySelectorAll('[data-dash-details]').forEach(btn=>{ btn.addEventListener('click', async (e)=>{ const id=e.currentTarget.getAttribute('data-dash-details'); const s=await getDoc(doc(db,'trips', id)); if(s.exists()) openDetails({id, ...s.data()}); }); });
    });
  }
</script>
</body>
</html>
