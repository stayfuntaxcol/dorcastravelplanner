<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dorcas Year Planner — Dashboard</title>
  <style>
    :root{
      --bg:#f6f7f9; --card:#fff; --ink:#111; --muted:#667085; --line:#e6e6e6;
      --ok:#22c55e; --warn:#fb923c; --bad:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial;background:var(--bg);color:var(--ink)}
    header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;background:#fff;border-bottom:1px solid var(--line);position:sticky;top:0;z-index:2}
    h1{font-size:18px;margin:0}
    .main{max-width:1100px;margin:24px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px}
    .btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
    .muted{color:var(--muted)}
    .hidden{display:none}

    input[type="email"],input[type="password"],input[type="search"],select{
      border:1px solid var(--line);border-radius:8px;padding:8px 10px;background:#fff
    }
    .row-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    @media (max-width:980px){ .row-3{grid-template-columns:1fr} }

    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-top:1px solid var(--line);text-align:left;vertical-align:top}
    th{font-weight:600;color:#475467;background:#fafafa}
    td.right{text-align:right}

    /* Pills */
    .pill{display:inline-flex;align-items:center;gap:6px;font-size:12px;padding:4px 10px;border-radius:999px;border:1px solid var(--line);background:#fafafa}
    .pill.green{background:#ecfdf5;border-color:#bbf7d0}
    .pill.orange{background:#fff7ed;border-color:#fed7aa}
    .pill.red{background:#fff1f2;border-color:#fecdd3}
    .status-dot{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:6px;vertical-align:middle}
    .dot-green{background:var(--ok)} .dot-orange{background:var(--warn)} .dot-red{background:var(--bad)}

    /* Auth panel */
    .auth{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

    /* Toolbar */
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px}
  </style>
</head>
<body>
  <header>
    <h1>Dorcas Year Planner — Dashboard</h1>
    <div class="auth" id="authPanel">
      <input type="email" id="email" placeholder="naam@dorcas.nl" />
      <input type="password" id="password" placeholder="wachtwoord" />
      <button class="btn" id="btnLogin">Inloggen</button>
      <button class="btn" id="btnRegister">Account aanmaken</button>
      <button class="btn hidden" id="btnLogout">Uitloggen</button>
    </div>
  </header>

  <div class="main">
    <div id="domainWarn" class="card hidden">Alleen <strong>@dorcas.nl</strong> accounts zijn toegestaan.</div>

    <!-- KPIs -->
    <div class="row-3">
      <div class="card"><strong># Reizen Totaal</strong><div id="kpiTripsTotal" style="font-size:24px">0</div></div>
      <div class="card"><strong># Reizen Approved</strong><div id="kpiTripsApproved" style="font-size:24px">0</div></div>
      <div class="card"><strong># Reizen Pending</strong><div id="kpiTripsPending" style="font-size:24px">0</div></div>
    </div>

    <div class="row-3" style="margin-top:8px">
      <div class="card"><strong>Euro Budget Totaal</strong><div id="kpiBudgetTotal" style="font-size:24px">€0</div></div>
      <div class="card"><strong>Euro Budget Approved</strong><div id="kpiBudgetApproved" style="font-size:24px">€0</div></div>
      <div class="card"><strong>Euro Budget Pending</strong><div id="kpiBudgetPending" style="font-size:24px">€0</div></div>
    </div>

    <div class="row-3" style="margin-top:8px">
      <div class="card"><strong>CO₂ (t) Uitstoot Totaal</strong><div id="kpiCO2Total" style="font-size:24px">0.0</div></div>
      <div class="card"><strong>CO₂ (t) Uitstoot Approved</strong><div id="kpiCO2Approved" style="font-size:24px">0.0</div></div>
      <div class="card"><strong>CO₂ (t) Uitstoot Pending</strong><div id="kpiCO2Pending" style="font-size:24px">0.0</div></div>
    </div>

    <!-- Filters (optioneel) -->
    <div class="toolbar card" style="margin-top:12px">
      <input type="search" id="dashSearch" placeholder="Zoek op titel/afdeling/CO/stad/vervoer…">
      <select id="dashStatus">
        <option value="">Status: alles</option>
        <option value="voorgenomen">Voorgenomen</option>
        <option value="definitief">Definitief</option>
        <option value="afgewezen">Afgewezen</option>
      </select>
      <select id="dashDept"><option value="">Afdeling: alles</option></select>
      <select id="dashQtr">
        <option value="">Qtr: alles</option>
        <option>Q1</option><option>Q2</option><option>Q3</option><option>Q4</option>
      </select>
      <button id="dashReset" class="btn">Reset</button>
    </div>

    <!-- Per afdeling -->
    <section class="card" style="margin-top:12px">
      <h3 style="margin:0 0 8px 0">Overzicht per afdeling</h3>
      <div style="overflow:auto">
        <table id="deptTable">
          <thead>
            <tr><th>Afdeling</th><th># Reizen</th><th>Euro</th><th>CO₂ (t)</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Alle reizen -->
    <section class="card" style="margin-top:12px">
      <h3 style="margin:0 0 8px 0">Alle reizen</h3>
      <div style="overflow:auto">
        <table id="tripsTable">
          <thead>
            <tr>
              <th>Status</th>
              <th>Titel</th>
              <th>Bestemming</th>
              <th>Vervoer</th>
              <th>Periode</th>
              <th>Qtr</th>
              <th>Dagen</th>
              <th>Euro</th>
              <th>CO₂ (t)</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </div>

  <!-- Firebase + App -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { getFirestore, collection, query, onSnapshot, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    // --- Firebase config (jouw project) ---
    const firebaseConfig = {
      apiKey: "AIzaSyAh8NlJEsAimk5XetB46b4hVmT83ZbHc4o",
      authDomain: "dorcas-travel-planner.firebaseapp.com",
      projectId: "dorcas-travel-planner",
      storageBucket: "dorcas-travel-planner.firebasestorage.app",
      messagingSenderId: "964093814653",
      appId: "1:964093814653:web:5f5a542f9593f82cfe0e14",
      measurementId: "G-PZ3N4JRKQ3"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db   = getFirestore();

    // ---- helpers ----
    const $ = (sel)=>document.querySelector(sel);
    const fmtDate = (s => s ? new Date(s).toLocaleDateString('nl-NL') : '');
    const fmtEUR  = (n => new Intl.NumberFormat('nl-NL',{style:'currency',currency:'EUR'}).format(n||0));
    const statusPill = (s=>{
      const m=(s||'').toLowerCase();
      if(m==='definitief') return '<span class="pill green"><span class="status-dot dot-green"></span>definitief</span>';
      if(m==='afgewezen')  return '<span class="pill red"><span class="status-dot dot-red"></span>afgewezen</span>';
      return '<span class="pill orange"><span class="status-dot dot-orange"></span>voorgenomen</span>';
    });
    const openDetails = (t=> alert(JSON.stringify(t,null,2)));
    const safe = v => (v==null?'':String(v)).replace(/[<>&]/g, s=>({ '<':'&lt;','>':'&gt;','&':'&amp;' }[s]));

    // ---- Auth UI ----
    const emailEl = $('#email'), passEl = $('#password');
    const btnLogin = $('#btnLogin'), btnRegister=$('#btnRegister'), btnLogout=$('#btnLogout');
    const domainWarn = $('#domainWarn');

    btnLogin.addEventListener('click', async ()=>{
      try{ await signInWithEmailAndPassword(auth, emailEl.value.trim(), passEl.value); }
      catch(e){ alert('Login: '+(e.code||e.message)); }
    });
    btnRegister.addEventListener('click', async ()=>{
      try{
        const mail = emailEl.value.trim();
        if(!/@dorcas\.nl$/i.test(mail)) return alert('Gebruik een @dorcas.nl e-mail.');
        await createUserWithEmailAndPassword(auth, mail, passEl.value);
      }catch(e){ alert('Registreren: '+(e.code||e.message)); }
    });
    btnLogout.addEventListener('click', ()=> signOut(auth));

    onAuthStateChanged(auth, async (u)=>{
      const isDorcas = /@dorcas\.nl$/i.test(u?.email||'');
      domainWarn.classList.toggle('hidden', !!isDorcas);
      $('#btnLogout').classList.toggle('hidden', !u);
      $('#btnLogin').classList.toggle('hidden', !!u);
      $('#btnRegister').classList.toggle('hidden', !!u);
      emailEl.classList.toggle('hidden', !!u);
      passEl.classList.toggle('hidden', !!u);
      if(u && isDorcas){ buildDashboard(); }
    });
    if (auth.currentUser) buildDashboard();

    // ---- DOM refs ----
    const dashSearch = $('#dashSearch');
    const dashStatus = $('#dashStatus');
    const dashDept   = $('#dashDept');
    const dashQtr    = $('#dashQtr');
    const dashReset  = $('#dashReset');

    const kpiTripsTotal = $('#kpiTripsTotal');
    const kpiTripsApproved = $('#kpiTripsApproved');
    const kpiTripsPending = $('#kpiTripsPending');
    const kpiBudgetTotal = $('#kpiBudgetTotal');
    const kpiBudgetApproved = $('#kpiBudgetApproved');
    const kpiBudgetPending = $('#kpiBudgetPending');
    const kpiCO2Total = $('#kpiCO2Total');
    const kpiCO2Approved = $('#kpiCO2Approved');
    const kpiCO2Pending = $('#kpiCO2Pending');

    const deptTBody = document.querySelector('#deptTable tbody');
    const tripsTBody = document.querySelector('#tripsTable tbody');

    // ---- Data/state ----
    let _allTrips = [];
    let _unsub = null;

    // budget/CO₂ helpers (houden rekening met IO budget + combi via opgeslagen effective velden)
    function getBudget(t){
      if (typeof t.budgetEffectiveTotal === 'number') return t.budgetEffectiveTotal;
      const base = (typeof t.budgetDefaultTotal === 'number') ? t.budgetDefaultTotal : 0;
      const io   = t.ioBudget === false ? 0 : 1;
      return base * io;
    }
    function getCO2(t){
      if (typeof t.co2EffectiveTotalTon === 'number') return t.co2EffectiveTotalTon;
      if (typeof t.co2TotalTon === 'number') return t.co2TotalTon;
      return 0;
    }

    async function populateDeptFilter(){
      if (dashDept && dashDept.options.length===1){
        try{
          const snap = await getDocs(collection(db,'departments'));
          if(!snap.empty){
            snap.forEach(d=>{
              const op=document.createElement('option'); op.value=d.id; op.textContent=d.id; dashDept.appendChild(op);
            });
          }
        }catch(_){}
      }
    }

    function applyFilters(rows){
      const q = (dashSearch.value||'').trim().toLowerCase();
      const st= (dashStatus.value||'').toLowerCase();
      const dep = dashDept.value || '';
      const qtr = dashQtr.value || '';
      return rows.filter(t=>{
        if (st && (t.status||'').toLowerCase()!==st) return false;
        if (dep && (t.department||'')!==dep) return false;
        if (qtr && (t.qtr||'')!==qtr) return false;
        if (q){
          const hay = [
            t.title, t.department, t.officeCountry, t.city, t.transport
          ].map(x=>(x||'').toString().toLowerCase()).join(' • ');
          if(!hay.includes(q)) return false;
        }
        return true;
      });
    }

    function renderKPIs(rows){
      const total = rows.length;
      const approvedRows = rows.filter(t=>(t.status||'').toLowerCase()==='definitief');
      const pendingRows  = rows.filter(t=>(t.status||'').toLowerCase()==='voorgenomen');

      const sum = (arr, f)=> arr.reduce((a,b)=> a + f(b), 0);
      const budgetTotal    = sum(rows, getBudget);
      const budgetApproved = sum(approvedRows, getBudget);
      const budgetPending  = sum(pendingRows, getBudget);

      const co2Total    = sum(rows, getCO2);
      const co2Approved = sum(approvedRows, getCO2);
      const co2Pending  = sum(pendingRows, getCO2);

      kpiTripsTotal.textContent    = String(total);
      kpiTripsApproved.textContent = String(approvedRows.length);
      kpiTripsPending.textContent  = String(pendingRows.length);

      kpiBudgetTotal.textContent    = fmtEUR(budgetTotal);
      kpiBudgetApproved.textContent = fmtEUR(budgetApproved);
      kpiBudgetPending.textContent  = fmtEUR(budgetPending);

      kpiCO2Total.textContent    = co2Total.toFixed(1);
      kpiCO2Approved.textContent = co2Approved.toFixed(1);
      kpiCO2Pending.textContent  = co2Pending.toFixed(1);
    }

    function renderDeptTable(rows){
      const group = {};
      rows.forEach(t=>{
        const d = t.department || 'Onbekend';
        if(!group[d]) group[d] = { n:0, eur:0, co2:0 };
        group[d].n++;
        group[d].eur += getBudget(t);
        group[d].co2 += getCO2(t);
      });

      const entries = Object.entries(group).sort((a,b)=> a[0].localeCompare(b[0]));
      deptTBody.innerHTML = entries.length ? '' : '<tr><td colspan="4" class="muted">Geen data.</td></tr>';
      for (const [dep, agg] of entries){
        deptTBody.insertAdjacentHTML('beforeend', `
          <tr>
            <td>${safe(dep)}</td>
            <td>${agg.n}</td>
            <td>${fmtEUR(agg.eur)}</td>
            <td>${agg.co2.toFixed(1)}</td>
          </tr>
        `);
      }
    }

    function renderTripsTable(rows){
      tripsTBody.innerHTML = rows.length ? '' : '<tr><td colspan="10" class="muted">Geen reizen gevonden.</td></tr>';
      rows.forEach(t=>{
        const dest = `${safe(t.officeCountry||'')}${t.city?(' • '+safe(t.city)):""}`;
        const days = t.durationDays ?? ((t.startDate && t.endDate) ? Math.floor((new Date(t.endDate)-new Date(t.startDate))/(1000*60*60*24))+1 : '');
        tripsTBody.insertAdjacentHTML('beforeend', `
          <tr>
            <td>${statusPill(t.status)}</td>
            <td>${safe(t.title||'')}</td>
            <td>${dest}</td>
            <td>${safe(t.transport||'')}</td>
            <td>${fmtDate(t.startDate)} – ${fmtDate(t.endDate)}</td>
            <td>${safe(t.qtr||'')}</td>
            <td>${days||''}</td>
            <td>${fmtEUR(getBudget(t))}</td>
            <td>${getCO2(t).toFixed(1)}</td>
            <td class="right"><button class="btn" data-details="${t.id}">Toon details</button></td>
          </tr>
        `);
      });

      // details
      tripsTBody.querySelectorAll('[data-details]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const id = btn.getAttribute('data-details');
          try {
            const s = await getDoc(doc(db,'trips', id));
            if (s.exists()) openDetails({id, ...s.data()});
          } catch(e) { alert('Details: '+(e.code||e.message)); }
        });
      });
    }

    function renderAll(){
      const filtered = applyFilters(_allTrips);
      renderKPIs(filtered);
      renderDeptTable(filtered);
      renderTripsTable(filtered);
    }

    async function buildDashboard(){
      await populateDeptFilter();
      if (_unsub) { renderAll(); return; }
      _unsub = onSnapshot(query(collection(db,'trips')), (snap)=>{
        const rows=[]; snap.forEach(d=> rows.push({id:d.id, ...d.data()}));
        _allTrips = rows;
        renderAll();
      }, (err)=>{
        alert('Dashboard: ' + (err.code||err.message));
      });
    }

    // Events filters
    [dashSearch, dashStatus, dashDept, dashQtr].forEach(el=>{
      el && el.addEventListener('input', renderAll);
      el && el.addEventListener('change', renderAll);
    });
    dashReset && dashReset.addEventListener('click', ()=>{
      dashSearch.value=''; dashStatus.value=''; dashDept.value=''; dashQtr.value='';
      renderAll();
    });
  </script>
</body>
</html>
